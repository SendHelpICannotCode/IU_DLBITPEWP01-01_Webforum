generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  createdAt    DateTime @default(now())
  posts        Post[]
  threads      Thread[]
}

model Thread {
  id             String           @id @default(cuid())
  title          String
  content        String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  currentVersion Int              @default(1)
  authorId       String
  isLocked       Boolean          @default(false)
  lockedAt       DateTime?
  lockedBy       String?
  posts          Post[]
  author         User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  versions       ThreadVersion[]
  categories     ThreadCategory[]

  @@index([isLocked])
}

model ThreadVersion {
  id        String   @id @default(cuid())
  threadId  String
  version   Int
  title     String
  content   String
  createdAt DateTime @default(now())
  thread    Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, version])
  @@index([threadId])
}

model Post {
  id             String        @id @default(cuid())
  content        String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  currentVersion Int           @default(1)
  threadId       String
  authorId       String
  author         User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  thread         Thread        @relation(fields: [threadId], references: [id], onDelete: Cascade)
  versions       PostVersion[]
}

model PostVersion {
  id        String   @id @default(cuid())
  postId    String
  version   Int
  content   String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, version])
  @@index([postId])
}

model Category {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  color       String?
  keywords    String[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  threads     ThreadCategory[]
}

model ThreadCategory {
  id         String   @id @default(cuid())
  threadId   String
  categoryId String
  createdAt  DateTime @default(now())
  thread     Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([threadId, categoryId])
  @@index([threadId])
  @@index([categoryId])
}

enum UserRole {
  USER
  ADMIN
}
